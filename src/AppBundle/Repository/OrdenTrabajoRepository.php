<?php

namespace AppBundle\Repository;

/**
 * OrdenTrabajoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class OrdenTrabajoRepository extends \Doctrine\ORM\EntityRepository
{
    public function findByTexto($sucursalId, $texto) {
        $query = 'SELECT u  FROM AppBundle:OrdenTrabajo u 
                  INNER JOIN u.cliente c
                  WHERE u.activo = 1 ';

        if ($sucursalId > 0)
            $query .= ' AND u.sucursal = :sucursalId ';

        if ($texto != '')
            $query .= ' AND (u.id LIKE :texto OR c.nombre LIKE :texto OR c.documentoNumero LIKE :texto) ';

        $query .= ' ORDER BY u.id DESC ';

        $em = $this->getEntityManager()->createQuery($query);

        if ($sucursalId > 0)
            $em->setParameter('sucursalId', $sucursalId);

        if ($texto != '')
            $em->setParameter('texto','%' . $texto . '%');
        
        //return $em;
        return $em->getResult();
    }

	public function findAll_sucursal($sucursal_id) {
		$em = $this->getEntityManager('default');
        
		$resultado = $em->createQuery('SELECT ot
                FROM AppBundle:OrdenTrabajo ot
                INNER JOIN ot.comprobante c
                WHERE ot.activo = 1
                and c.sucursal = :sucursal')
			->setParameter('sucursal', $sucursal_id)
			->getResult();

        return $resultado;
    }

    public function findAll_sucursalFecha($sucursal_id, $fecha) {
        $em = $this->getEntityManager('default');
        
        $resultado = $em->createQuery('SELECT ot
                FROM AppBundle:OrdenTrabajo ot
                INNER JOIN ot.comprobante c
                WHERE ot.activo = 1
                and c.sucursal = :sucursal
                and c.fecha = :fecha ')
            ->setParameter('sucursal', $sucursal_id)
            ->setParameter('fecha', $fecha)
            ->getResult();

        return $resultado;
    }

    public function findByTextoFinalizadas($sucursalId, $texto) {
        $query = 'SELECT u  FROM AppBundle:OrdenTrabajo u 
                  INNER JOIN u.cliente c
                  WHERE u.activo = 1 and u.estado = :estado';

        if ($sucursalId > 0)
            $query .= ' AND u.sucursal = :sucursalId ';

        if ($texto != '')
            $query .= ' AND (u.id LIKE :texto OR c.nombre LIKE :texto OR c.documentoNumero LIKE :texto) ';

        $query .= ' ORDER BY u.id DESC ';

        $em = $this->getEntityManager()->createQuery($query);

        if ($sucursalId > 0)
            $em->setParameter('sucursalId', $sucursalId);

        if ($texto != '')
            $em->setParameter('texto','%' . $texto . '%');
        
        $em->setParameter('estado',"Finalizado");
        
        //return $em;
        return $em->getResult();
    }

    public function findByTextoNoFinalizadas($sucursalId, $texto) {
        $query = 'SELECT u  FROM AppBundle:OrdenTrabajo u 
                  INNER JOIN u.cliente c
                  WHERE u.activo = 1 and u.estado <> :estado';

        if ($sucursalId > 0)
            $query .= ' AND u.sucursal = :sucursalId ';

        if ($texto != '')
            $query .= ' AND (u.id LIKE :texto OR c.nombre LIKE :texto OR c.documentoNumero LIKE :texto) ';

        $query .= ' ORDER BY u.id DESC ';

        $em = $this->getEntityManager()->createQuery($query);

        if ($sucursalId > 0)
            $em->setParameter('sucursalId', $sucursalId);

        if ($texto != '')
            $em->setParameter('texto','%' . $texto . '%');

        $em->setParameter('estado',"Finalizado");
        
        //return $em;
        return $em->getResult();
    }
}
