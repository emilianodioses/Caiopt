{% extends 'base.html.twig' %}

{% block header %}
Nueva Orden de Pago
{% endblock %}

{% block header_description %}
{% endblock %}

{% block extra_js %}
    <script src="{{ asset('js/jquery.collection.js') }}"></script>
{% endblock %}

{% block body %}  

<script>
$(function(){
    var hash = window.location.hash;
    hash && $('ul.nav a[href="' + hash + '"]').tab('show');

    $('.nav-tabs a').click(function (e) {
      $(this).tab('show');
      var scrollmem = $('body').scrollTop() || $('html').scrollTop();
      window.location.hash = this.hash;
      $('html,body').scrollTop(scrollmem);
    });
  });
</script>

{% form_theme form 'ordenpago/formCollection.html.twig' %}
{{ form(form, {'ordenPagoComprobantes': ordenPagoComprobantes, 'ordenPago': ordenPago}) }}
{{ form_end(form) }}

<script type="text/javascript">
    var COL_COMPROBANTE_ID = 0;
    var COL_CHECKBOX = 1
    var COL_PUNTOVENTA = 2;
    var COL_NRO_FACTURA = 3;
    var COL_TIPO = 4;
    var COL_TOTAL = 5;
    var COL_PENDIENTE = 6;

    $('.proveedorPago-collection').collection({
        allow_duplicate: false,
        allow_up: false,
        allow_down: false,
        init_with_n_elements: 1,
        add_at_the_end: true,
        add: '<a href="#" class="btn btn-default" title="Agregar ArtÃ­culo"><span class="glyphicon glyphicon-plus-sign"></span></a>',
        elements_selector: 'tr.item',
        elements_parent_selector: '%id% tbody',
        after_add: function(collection, element) {
            element.on('change', function(){
                fnRenglonChange($(this));
            });

            return true;
         },
         after_remove: function(collection, element) {
            //Recalculo todos los totales
            fnCalcularTotales();

            return true;
         }
    });

    function fnRenglonChange(renglon) {
        fnCalcularTotales(renglon);

        return true;
    }

    function fnCalcularTotales(renglon) {
        //Verifico el tipo de pago seleccionado para habilitar o deshabilitar los datos adicionales
        var r_pagoTipo = renglon.find("select.pagoTipo");
        var r_banco = renglon.find("select.banco");
        var r_fecha = renglon.find("input.fecha");
        var r_numero = renglon.find("input.numero");

        var pagoTipoTexto = r_pagoTipo.find('option:selected').text();
        if (pagoTipoTexto == 'Cheque' || pagoTipoTexto == 'Transferencia') {
            r_banco.prop('disabled', false);
            r_fecha.prop('readonly', false);
            r_numero.prop('readonly', false);
        }
        else {
            r_banco.val(0);
            r_banco.prop('disabled', true);
            r_fecha.val('');
            r_fecha.prop('readonly', true);
            r_numero.val('');
            r_numero.prop('readonly', true);
        }
        
        //Calculo los totales
        var total = 0;
        
        $("#OrdenPagoType_proveedorPagos tr.item").each(function() {
            var r_importe = $(this).find("input.importe");
            
            total += parseFloat(r_importe.val());
            //total += parseFloat(importe_iva);
        });

        var pendiente = parseFloat($('#total_pendiente').val());

        var disponible = total - pendiente;
        if (disponible < 0) {
            disponible = 0;
        }

        $("#OrdenPagoType_total").val(total.toFixed(2));
        $("#OrdenPagoType_disponible").val(disponible.toFixed(2));

        //$("#OrdenPagoType_totalCosto").val(total_costo.toFixed(2));
        //$("#OrdenPagoType_totalGanancia").val(total.toFixed(2)-total_costo.toFixed(2));

        return true;
    }

    function comprobante_checked(argument) {
        var total = 0;

        $('#orden_pago_comprobantes tr').each(function(row, tr){
            comprobante_id = $(tr).find('td:eq('+COL_COMPROBANTE_ID+')').text();
            tipo = $(tr).find('td:eq('+COL_TIPO+')').text();
            
            
            var x = document.getElementById($(tr).find('td:eq('+COL_COMPROBANTE_ID+')').text());

            if (x !== null) {
                if (x.checked) {
                    if (tipo == 'NOTA DE CREDITO A' ||
                        tipo == 'NOTA DE CREDITO B' || 
                        tipo == 'NOTA DE CREDITO C') {
                        
                        total -= parseFloat($(tr).find('td:eq('+COL_PENDIENTE+')').text());
                    }
                    else {
                        total += parseFloat($(tr).find('td:eq('+COL_PENDIENTE+')').text());
                    }
                }
            }
        });

        $('#total_pendiente').val(total.toFixed(2));
        fnCalcularTotales();
    };

    function getComprobantes(){
        var TableData = new Array();
        var i = 0;
        
        $('#orden_pago_comprobantes tr').each(function(row, tr){
            comprobante_id = $(tr).find('td:eq('+COL_COMPROBANTE_ID+')').text();
            
            var x = document.getElementById($(tr).find('td:eq('+COL_COMPROBANTE_ID+')').text());

            if (x !== null) {
                if (x.checked) {
                    TableData[i]={"id": comprobante_id};

                    i++;
                }
            }
        });

        return TableData;
    }

    function submitform() {
        var comprobantes = getComprobantes();
        comprobantes = JSON.stringify(comprobantes);

        var form = document.getElementsByName("OrdenPagoType")[0];

        $('<input />').attr('type', 'hidden')
            .attr('name', "comprobantes")
            .attr('value', comprobantes)
            .appendTo(form);

        return true;
    };
</script>          

{% endblock %}
